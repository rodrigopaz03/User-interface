{% extends "core/base.html" %}
{% block title %}Actualizar Historia Clínica{% endblock %}
{% block content %}
  <h2>Actualizar Historia Clínica</h2>
  <label for="paciente">Seleccione paciente:</label>
  <select id="paciente"></select>

  <form id="form-historia" style="margin-top:1em;">
    <div>
      <label>Descripción:</label>
      <textarea name="descripcion" rows="4"></textarea>
    </div>
    <div>
      <label>Médico responsable:</label>
      <input type="text" name="medico_responsable">
    </div>
    <div>
      <label>Actualizado por:</label>
      <input type="text" name="updated_by">
    </div>
    <button type="submit">Guardar cambios</button>
  </form>

  <div id="msg" style="margin-top:1em;color:green;"></div>
{% endblock %}

{% block scripts %}
<script>
const API = "{{ API_BASE }}";
let currentHistoriaId = null;

// 1) Poblar select de pacientes
fetch(`${API}pacientes/`)
  .then(r => r.json())
  .then(js => {
    js.results.forEach(p => {
      document.getElementById('paciente')
        .innerHTML += `<option value="${p.id}">${p.nombre} ${p.apellido}</option>`;
    });
  });

// 2) Al cambiar paciente, cargar datos existentes
document.getElementById('paciente').addEventListener('change', e => {
  const pid = e.target.value;
  fetch(`${API}historias/?paciente=${pid}`)
    .then(r => r.json())
    .then(js => {
      const f = document.forms['form-historia'];
      if (!js.results.length) {
        currentHistoriaId = null;
        f.reset();
        return;
      }
      const h = js.results[0];
      currentHistoriaId = h.id;
      f.descripcion.value = h.descripcion || '';
      f.medico_responsable.value = h.medico_responsable || '';
      f.updated_by.value = '';
    });
});

// 3) Al enviar, hacer PATCH
document.getElementById('form-historia')
  .addEventListener('submit', e => {
    e.preventDefault();
    if (!currentHistoriaId) {
      alert('Primero selecciona un paciente con historia.');
      return;
    }
    const data = {
      descripcion: e.target.descripcion.value,
      medico_responsable: e.target.medico_responsable.value,
      updated_by: e.target.updated_by.value
    };
    fetch(`${API}historias/${currentHistoriaId}/`, {
      method: 'PATCH',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify(data)
    })
    .then(r => {
      if (r.ok) {
        document.getElementById('msg').innerText = 'Historia actualizada con éxito';
      } else {
        document.getElementById('msg').innerText = 'Error al actualizar';
      }
    });
});
</script>
{% endblock %}
